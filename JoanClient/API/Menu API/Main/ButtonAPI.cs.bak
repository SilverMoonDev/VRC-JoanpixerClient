using System;
using System.Collections;
using System.Linq;
using MelonLoader;
using JoanpixerButtonAPI.Misc;
using UnityEngine;
using UnityEngine.UI;
using VRC.UI.Elements;
using JoanpixerClient.API;
using JoanpixerClient.Utility;
using System.Reflection;
using VRC.SDKBase;
using VRC.UI;

namespace JoanpixerButtonAPI
{
    public class ButtonAPI : MelonLoaderEvents
    {
        public static GameObject singleButtonBase;

        public static GameObject toggleButtonBase;

        public static GameObject buttonGroupBase;

        public static GameObject buttonGroupHeaderBase;

        public static GameObject menuPageBase;

        public static GameObject menuTabBase;

        public static GameObject wingSingleButtonBase;

        public static GameObject sliderBase;

        public static Sprite onIconSprite;

        public static Sprite xIconSprite;

        public static bool HasInit = false;

        public static MethodInfo UseKeyboardOnlyForText;

        public static bool PauseInit = false;

        public static VRC.UI.Elements.QuickMenu GetQuickMenuInstance()
        {
            return Resources.FindObjectsOfTypeAll<VRC.UI.Elements.QuickMenu>().FirstOrDefault();
        }

        public static MenuStateController GetMenuStateControllerInstance()
        {
            return Resources.FindObjectsOfTypeAll<VRC.UI.Elements.QuickMenu>().FirstOrDefault()?.gameObject.GetOrAddComponent<MenuStateController>();
        }

        public override void OnUiManagerInit()
        {
            MelonCoroutines.Start(WaitForQMClone());
        }

        private static IEnumerator WaitForQMClone()
        {
            while (GameObject.Find("UserInterface")?.transform?.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Dashboard/ScrollRect/Viewport/VerticalLayoutGroup/Buttons_QuickActions/")?.gameObject == null || GameObject.Find("UserInterface")?.transform?.Find("Canvas_QuickMenu(Clone)/Container/Window/Wing_Left/Container/InnerContainer/WingMenu/ScrollRect/Viewport/VerticalLayoutGroup/Button_Explore")?.gameObject == null || GetMenuStateControllerInstance() == null)
            {
                yield return new WaitForEndOfFrame();
            }

            yield return new WaitForSeconds(2f); // Just In Case!

            singleButtonBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Dashboard/ScrollRect/Viewport/VerticalLayoutGroup/Buttons_QuickActions/Button_Respawn")?.gameObject;

            if (singleButtonBase == null)
            {
                JoanpixerClient.Logger.Error("singleButtonBase == null!");
            }

            toggleButtonBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Settings/Panel_QM_ScrollRect/Viewport/VerticalLayoutGroup/Buttons_UI_Elements_Row_1/Button_ToggleQMInfo")?.gameObject;

            if (toggleButtonBase == null)
            {
                JoanpixerClient.Logger.Error("toggleButtonBase == null!");
            }

            buttonGroupBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Dashboard/ScrollRect/Viewport/VerticalLayoutGroup/Buttons_QuickActions")?.gameObject;

            if (buttonGroupBase == null)
            {
                JoanpixerClient.Logger.Error("buttonGroupBase == null!");
            }

            new MenuButton(MenuType.WorldInfoMenu, MenuButtonType.WorldIfoButton, "Custom Tag", 548, -190, () =>
            {
                CreateTextPopup();
            });

            new MenuButton(MenuType.HeaderAvatarMenu, MenuButtonType.AvatarFavButton, "Download VRCA", 548, 0, () =>
            {
                JoanpixerClient.Features.VRCA.DownloadVRCA(JoanpixerClient.Modules.AvatarFavs.currPageAvatar.field_Public_SimpleAvatarPedestal_0.field_Internal_ApiAvatar_0, JoanpixerClient.Modules.AvatarFavs.currPageAvatar.field_Public_SimpleAvatarPedestal_0.field_Internal_ApiAvatar_0.thumbnailImageUrl);
            });

            var uwu = GameObject.Find("UserInterface/MenuContent/Screens/Avatar/TitlePanel (1)/UwU/Horizontal/FavoritesCountSpacingText");
            var uwu1 = GameObject.Find("UserInterface/MenuContent/Screens/Avatar/TitlePanel (1)/UwU/Horizontal/FavoritesCurrentCountText");
            var uwu2 = GameObject.Find("UserInterface/MenuContent/Screens/Avatar/TitlePanel (1)/UwU/Horizontal/FavoritesCountDividerText");
            var uwu3 = GameObject.Find("UserInterface/MenuContent/Screens/Avatar/TitlePanel (1)/UwU/Horizontal/FavoritesMaxAvailableText");
            var uwu4 = GameObject.Find("UserInterface/MenuContent/Screens/Avatar/TitlePanel (1)/UwU/Icon_VRC+");

            UnityEngine.Object.Destroy(uwu);
            UnityEngine.Object.Destroy(uwu1);
            UnityEngine.Object.Destroy(uwu2);
            UnityEngine.Object.Destroy(uwu3);
            UnityEngine.Object.Destroy(uwu4);

            buttonGroupHeaderBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Settings/Panel_QM_ScrollRect/Viewport/VerticalLayoutGroup/QM_Foldout_UI_Elements")?.gameObject;

            if (buttonGroupHeaderBase == null)
            {
                JoanpixerClient.Logger.Error("buttonGroupHeaderBase == null!");
            }

            menuPageBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Dashboard")?.gameObject;

            if (menuPageBase == null)
            {
                JoanpixerClient.Logger.Error("menuPageBase == null!");
            }

            menuTabBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/Page_Buttons_QM/HorizontalLayoutGroup/Page_Settings")?.gameObject;

            if (menuTabBase == null)
            {
                JoanpixerClient.Logger.Error("menuTabBase == null!");
            }

            wingSingleButtonBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/Wing_Left/Container/InnerContainer/WingMenu/ScrollRect/Viewport/VerticalLayoutGroup/Button_Explore")?.gameObject;

            if (wingSingleButtonBase == null)
            {
                JoanpixerClient.Logger.Error("wingSingleButtonBase == null!");
            }

            sliderBase = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_AudioSettings/Content/Audio/VolumeSlider_Master")?.gameObject;

            if (sliderBase == null)
            {
                JoanpixerClient.Logger.Error("sliderBase == null!");
            }

            //For Toggles
            onIconSprite = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Notifications/Panel_NoNotifications_Message/Icon")?.GetComponent<Image>()?.sprite;

            if (onIconSprite == null)
            {
                JoanpixerClient.Logger.Error("onIconSprite == null!");
            }

            xIconSprite = GameObject.Find("UserInterface").transform.Find("Canvas_QuickMenu(Clone)/Container/Window/QMParent/Menu_Here/ScrollRect/Viewport/VerticalLayoutGroup/Buttons_WorldActions/Button_FavoriteWorld/Icon_Secondary")?.GetComponent<Image>()?.sprite;

            if (xIconSprite == null)
            {
                JoanpixerClient.Logger.Error("xIconSprite == null!");
            }

            while (PauseInit)
            {
                yield return new WaitForEndOfFrame();
            }

            OnInit?.Invoke();

            HasInit = true;
        }

        private static void CreateTextPopup()
        {
            UseKeyboardOnlyForText.Invoke(null, new object[] { true });

            BuiltinUiUtils.ShowInputPopup("Joanpixer Client", null, InputField.InputType.Standard, false, "Join", (message, _, _2) =>
            {
                UseKeyboardOnlyForText.Invoke(null, new object[] { false });
                var world = GameObject.Find("UserInterface/MenuContent/Screens/WorldInfo").GetComponent<PageWorldInfo>().prop_ApiWorld_0.id;
                string messagejoined = message.Replace(" ", "");
                Networking.GoToRoom(world + ":" + messagejoined + "~region(eu)");
            }, () => { UseKeyboardOnlyForText.Invoke(null, new object[] { false }); }, "Custom Tag:", true, null, false, 16);

        }

        public static event Action OnInit;
    }

    /// <summary>
    ///   A Component For Hooking To Generic Events Such As A Object Becoming Enabled, Disabled, Destroyed And For Events Such
    ///   As Update.
    /// </summary>
    [RegisterTypeInIl2Cpp]
    public class ObjectHandler : MonoBehaviour
    {
        private bool IsEnabled;
        public Action<GameObject> OnDestroyed = null;
        public Action<GameObject> OnDisabled = null;

        public Action<GameObject> OnEnabled = null;
        public Action<GameObject, bool> OnUpdate = null;
        public Action<GameObject, bool> OnUpdateEachSecond = null;
        private float UpdateDelay = 0f;

        public ObjectHandler(IntPtr instance) : base(instance)
        {
        }

        private void OnEnable()
        {
            OnEnabled?.Invoke(gameObject);
            IsEnabled = true;
        }

        private void OnDisable()
        {
            OnDisabled?.Invoke(gameObject);
            IsEnabled = false;
        }

        private void OnDestroy()
        {
            OnDestroyed?.Invoke(gameObject);
        }

        private void Update()
        {
            OnUpdate?.Invoke(gameObject, IsEnabled);

            if (UpdateDelay < Time.time)
            {
                UpdateDelay = Time.time + 1f;

                OnUpdateEachSecond?.Invoke(gameObject, IsEnabled);
            }
        }
    }
}